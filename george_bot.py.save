# Grumpy George (GOG) v1.2
# Requirements: python-telegram-bot==20.7
# Features: /start, /roast, tag replies, anti-spam, anti-scam links, join CAPTCHA + roast welcome
from telegram import (
    Update, InlineKeyboardMarkup, InlineKeyboardButton, ChatMember,
)
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    CallbackQueryHandler, ContextTypes, filters,
)
from collections import deque
import time
import random
import asyncio
import re
import logging

BOT_TOKEN = "8000468938:AAGy_DU4CfEF2vD1y0LPQYH3Uc4gQpFgpVY"

# -----------------------------
# Logging
# -----------------------------
logging.basicConfig(
    format="%(asctime)s | %(levelname)s | %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger("grumpy_george")

# -----------------------------
# Personality lines
# -----------------------------
GRUMPY_REPLIES = [
    "What do you want now?",
    "You again? Buy me a pint first.",
    "Speak up, I can‚Äôt hear you over all the hype.",
    "I‚Äôm not your therapist ‚Äî go talk to your wallet.",
    "Still old, still grumpy, still right.",
    "Ask me after coffee. Or never.",
    "Back in my day we had fewer questions and more profit.",
    "You tag me, I charge interest.",
    "I‚Äôve got slippers older than your portfolio.",
    "If it‚Äôs not about $GOG, move along.",
    "I read your tag ‚Äî didn‚Äôt enjoy it.",
    "You brought opinions but left facts at home.",
    "That better be important. It wasn‚Äôt? Thought so.",
    "Put some respect on it, lad.",
    "I‚Äôd clap back harder, but I might pull a hip.",
    "Bother me again and I‚Äôll short your optimism.",
    "Use fewer words. My patience has decimals: 0.",
    "Tread lightly. I woke up on the wrong decade.",
    "I‚Äôve seen healthier charts on a heart monitor.",
    "Ask yourself: ‚Äòdoes George care?‚Äô The answer is no.",
    "I‚Äôve had more fun reading tax forms.",
    "If common sense was a token, you‚Äôd be illiquid.",
    "Not now. I‚Äôm busy not trusting the market.",
    "I don‚Äôt do hopium. I do sarcasm.",
    "You call that alpha? That‚Äôs diet rumor.",
    "Tagging me won‚Äôt pump your bags, sunshine.",
    "I‚Äôd tell you a secret, but you‚Äôd tweet it.",
    "When I want noise, I‚Äôll open Twitter.",
    "If it sounds too good, it is.",
    "Less moon talk, more execution.",
    "My patience is a support line: already broken.",
    "Cute question. Shame about the logic.",
    "I‚Äôd answer, but you won‚Äôt listen.",
    "Don‚Äôt test me. I fail people for sport.",
    "Come back when your chart stops crying.",
    "I don‚Äôt give ‚ÄòNFA‚Äô. I give ‚ÄòNAH‚Äô.",
    "Mixed feelings? I prefer mixed drinks.",
    "Yes. No. Maybe. There. Fully transparent.",
    "You want validation; I offer evaluation.",
    "I see confusion is trending again.",
    "Short answer: no. Long answer: absolutely not.",
    "I admire your enthusiasm. Pity about the timing.",
    "You call it ‚Äòstrategy‚Äô; I call it copium.",
    "Please, keep stacking excuses.",
    "Try thinking. It‚Äôs like leverage but safer.",
    "If I had a nickel for every bad take‚Ä¶ I‚Äôd buy the dip.",
    "Markets don‚Äôt care about feelings. Neither do I.",
    "Ask the chart. I‚Äôm retired from caring.",
    "That‚Äôs your plan? I‚Äôve seen better rugs.",
    "Save the tag. Spend the effort.",
]
ROASTS = [
    "You trade like you‚Äôve got oven mitts on.",
    "I‚Äôve seen garden gnomes with more ambition.",
    "Back in my day even scams had standards.",
    "Your risk management is just wishing.",
    "You‚Äôre a buy-high, sell-low specialist.",
    "You FOMO‚Äôd so hard you left your wallet behind.",
    "Your stop loss is pure imagination.",
    "You call that TA? That‚Äôs abstract art.",
    "I‚Äôve seen sturdier hands on a jellyfish.",
    "You set alerts just to snooze them.",
    "Your edge is a circle.",
    "You could rug a picnic blanket.",
    "If patience was a token you‚Äôd be bankrupt.",
    "You chase green candles like moths to a flame.",
    "Your DCA is just ‚ÄòDesperate Candle Addition‚Äô.",
    "You call it a thesis; it‚Äôs a diary of delusions.",
    "You hold conviction like a wet paper bag.",
    "You‚Äôd front-run a bus‚Ä¶ from behind.",
    "I‚Äôve seen bots with more personality and better PnL.",
    "You buy resistance and sell support. Iconic.",
    "Your alpha leaks faster than your conviction.",
    "The only thing you accumulate is regrets.",
    "Even your memes are illiquid.",
    "You couldn‚Äôt find liquidity with a map.",
    "You average down until the floor gives up.",
    "Your indicators point to ‚Äòcope‚Äô.",
    "You do research by reading replies.",
    "You think ‚Äòlocked LP‚Äô means locked expectations.",
    "You call that utility? It‚Äôs a coaster.",
    "Your plan is ‚Äòvibes and vibes alone‚Äô.",
    "You need a mentor. Or a mirror.",
    "You‚Äôd sell the top if it was the bottom.",
    "If hopium paid, you‚Äôd be a whale.",
    "Your backtest was a bedtime story.",
    "Diversified? You own ten of the same mistake.",
    "You chart with crayons.",
    "You long anxiety and short sleep.",
    "You‚Äôd get front-run by a turtle.",
    "If patience was APR, you‚Äôd earn 0%.",
    "Your ‚Äòresearch‚Äô is just recycled cope.",
    "You trust influencers with unverified eyebrows.",
    "You ape like the barrel is on fire.",
    "You ‚Äòsecure profits‚Äô by imagining them.",
    "Liquidations fear your portfolio out of pity.",
    "You could misclick a hardware wallet.",
    "Your slippage tolerance is your personality.",
    "You ‚Äònibble the dip‚Äô and choke on fees.",
    "You hold like a windy plastic bag.",
    "Even rugs avoid you out of respect.",
    "You don‚Äôt miss opportunities‚Äîopportunities miss you.",
]
WELCOME_ROASTS = [
    "Fine, you‚Äôre in. Don‚Äôt make me regret it.",
    "Verified. Try not to trip over your own bags.",
    "Human detected. Barely.",
    "You passed. Standards are low today.",
    "Alright, sit down and don‚Äôt touch anything.",
    "Great, another genius. Park yourself.",
    "Welcome. Now behave or be gone.",
    "Okay, okay ‚Äî just don‚Äôt spam.",
]

# -----------------------------
# Runtime state
# -----------------------------
SPAM_TRACK = {}
SPAM_WINDOW_SECONDS = 5
SPAM_MAX_MSGS = 3
PENDING_CAPTCHAS = {}
LINK_WARN = {}
LINK_REGEX = re.compile(r"(t\\.me/|joinchat|https?://)", re.I)

# -----------------------------
# Helpers
# -----------------------------
async def is_admin(context: ContextTypes.DEFAULT_TYPE, chat_id: int, user_id: int) -> bool:
    try:
        member = await context.bot.get_chat_member(chat_id, user_id)
        return member.status in (ChatMember.OWNER, ChatMember.ADMINISTRATOR)
    except Exception:
        return False

def mark_spam(chat_id: int, user_id: int) -> int:
    now = time.time()
    chat_bucket = SPAM_TRACK.setdefault(chat_id, {})
    u = chat_bucket.setdefault(user_id, {"times": deque(), "strikes": 0})
    dq = u["times"]
    dq.append(now)
    while dq and now - dq[0] > SPAM_WINDOW_SECONDS:
        dq.popleft()
    return len(dq)

def inc_strike(chat_id: int, user_id: int) -> int:
    chat_bucket = SPAM_TRACK.setdefault(chat_id, {})
    u = chat_bucket.setdefault(user_id, {"times": deque(), "strikes": 0})
    u["strikes"] += 1
    return u["strikes"]

def reset_user_spam(chat_id: int, user_id: int):
    chat_bucket = SPAM_TRACK.setdefault(chat_id, {})
    chat_bucket[user_id] = {"times": deque(), "strikes": 0}

2# -----------------------------
# Commands
# -----------------------------
async def start_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Oi, it‚Äôs Grumpy George here! What do you want? üò†")
    print(f"Chat ID for this group is: {update.effective_chat.id}")

async def roast_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(random.choice(ROASTS))

# -----------------------------
# Anti-bot CAPTCHA on join
# -----------------------------
async def on_new_members(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message or not update.message.new_chat_members:
        return
    chat_id = update.effective_chat.id
    for new_member in update.message.new_chat_members:
        choices = ["‚úÖ", "üî•", "üê∏", "üí©", "üß†", "‚ùå"]
        answer = random.choice(choices)
        shuffled = choices[:]
        random.shuffle(shuffled)
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton(c, callback_data=f"captcha:{chat_id}:{new_member.id}:{c}")]
            for c in shuffled
        ])
        prompt = (
            f"Welcome, {new_member.mention_html()}.\n"
            f"Prove you‚Äôre not a useless bot: tap <b>{answer}</b> within 30 seconds."
        )
        msg = await update.message.reply_html(prompt, reply_markup=keyboard)
        PENDING_CAPTCHAS[(chat_id, new_member.id)] = {
            "message_id": msg.message_id,
            "answer": answer,
            "deadline": time.time() + 30.0,
        }
        context.application.create_task(captcha_timeout(context, chat_id, new_member.id))

async def captcha_timeout(context: ContextTypes.DEFAULT_TYPE, chat_id: int, user_id: int):
    await asyncio.sleep(31)
    key = (chat_id, user_id)
    data = PENDING_CAPTCHAS.get(key)
    if not data:
        return
    try:
        await context.bot.ban_chat_member(chat_id, user_id)
        await context.bot.unban_chat_member(chat_id, user_id)
    except Exception:
        pass
    try:
        await context.bot.delete_message(chat_id, data["message_id"])
    except Exception:
        pass
    PENDING_CAPTCHAS.pop(key, None)

async def on_captcha_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.callback_query:
        return
    q = update.callback_query
    try:
        _, chat_id_str, user_id_str, pressed = q.data.split(":", 3)
        chat_id = int(chat_id_str)
        user_id = int(user_id_str)
    except Exception:
        await q.answer()
        return
    if update.effective_user.id != user_id:
        await q.answer("Not your button, pal.")
        return
    data = PENDING_CAPTCHAS.get((chat_id, user_id))
    if not data:
        await q.answer("Too slow.")
        return
    correct = data["answer"]
    if pressed == correct:
        await q.answer("Fine. You‚Äôre in.")
        try:
            await q.edit_message_text("Verified. Don‚Äôt cause trouble.")
        except Exception:
            pass
        PENDING_CAPTCHAS.pop((chat_id, user_id), None)
        try:
            await context.bot.send_message(chat_id, random.choice(WELCOME_ROASTS))
        except Exception:
            pass
    else:
        await q.answer("Wrong.")

# -----------------------------
# Anti-spam + scam-link + tag replies
# -----------------------------
async def text_guard(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message or not update.effective_chat or not update.effective_user:
        return
    chat_id = update.effective_chat.id
    user_id = update.effective_user.id
    text = (update.message.text or "").strip()

    # --- Scam link detection ---
    if LINK_REGEX.search(text):
        if user_id not in LINK_WARN:
            LINK_WARN[user_id] = time.time()
            try:
                await update.message.delete()
            except Exception:
                pass
            await context.bot.send_message(
                chat_id,
                f"{update.effective_user.mention_html()} ‚Äî stop dropping dodgy links! One more and you‚Äôre out. üò†",
                parse_mode="HTML",
            )
            return
        else:
            try:
                await context.bot.ban_chat_member(chat_id, user_id)
                await context.bot.unban_chat_member(chat_id, user_id)
                await context.bot.send_message(
                    chat_id,
                    f"{update.effective_user.first_name} thought we wouldn‚Äôt notice‚Ä¶ kicked for spam links. üö´",
                )
            except Exception:
                pass
            LINK_WARN.pop(user_id, None)
            return

    # --- Anti-spam flood ---
    if not await is_admin(context, chat_id, user_id):
        if not text.startswith("/"):
            count = mark_spam(chat_id, user_id)
            if count > SPAM_MAX_MSGS:
                strikes = inc_strike(chat_id, user_id)
                if strikes == 1:
                    try:
                        await update.message.reply_text("Oi! Slow down or you‚Äôre out. That‚Äôs your only warning.")
                    except Exception:
                        pass
                else:
                    try:
                        await context.bot.ban_chat_member(chat_id, user_id)
                        await context.bot.unban_chat_member(chat_id, user_id)
                        await context.bot.send_message(chat_id, "Told you. Out you go.")
                    except Exception:
                        pass
                    reset_user_spam(chat_id, user_id)
                    return

    # --- Tag-only replies ---
    if "bot_username" not in context.bot_data:
        me = await context.bot.get_me()
        context.bot_data["bot_username"] = f"@{me.username}".lower()
    bot_handle = context.bot_data["bot_username"]
    if bot_handle and bot_handle in text.lower():
        await update.message.reply_text(random.choice(GRUMPY_REPLIES))

# -----------------------------
# Twitter Feed Integration (v1.2+)
# -----------------------------
import feedparser
import httpx

LAST_TWEETS = set()

# Use RSSHub for a stable Twitter feed source
NITTER_MIRRORS = [
    "https://nitter.net",
    "https://nitter.poast.org",
    "https://nitter.projectsegfau.lt",
    "https://nitter.privacydev.net",
    "https://nitter.cz",
    "https://rsshub.app/twitter/user"  # ‚úÖ fallback
]
TWITTER_HANDLE = "officialGOGcoin"
TWITTER_CHECK_INTERVAL = 300  # 5 minutes

async def check_twitter_feed(context: ContextTypes.DEFAULT_TYPE):
    """Poll Twitter via multiple Nitter mirrors and post new tweets."""
    data = None

    # Use local RSSHub instance for Twitter feed
    feed_url = f"http://localhost:1200/twitter/user/{TWITTER_HANDLE}/rss"
    try:
        async with httpx.AsyncClient(timeout=10) as client:
            resp = await client.get(feed_url, follow_redirects=True)
            if resp.status_code != 200:
                print(f"Twitter feed error: Bad status code {resp.status_code}")
                return

            parsed = feedparser.parse(resp.text)
            if not parsed.entries:
                print("Twitter feed error: No entries found in RSS feed")
                return

            data = parsed
            print("Twitter feed OK via local RSSHub")
    except Exception as e:
        print(f"Twitter feed request failed: {e}")

    if not data:
        print("Twitter feed error: All connection attempts failed")
        return

    try:
        import sys
        print("DEBUG: Latest tweet IDs:", [entry.id for entry in data.entries[:3]])
        sys.stdout.flush()
        for entry in data.entries[:3]:
            if entry.id not in LAST_TWEETS:
                LAST_TWEETS.add(entry.id)
                msg = f"üê¶ <b>New tweet from @{TWITTER_HANDLE}:</b>\n{entry.title}\n{entry.link}"
                await context.bot.send_message(
                    chat_id=context.job.chat_id,
                    text=msg,
                    parse_mode="HTML",
                    disable_web_page_preview=False,
                )
    except Exception as e:
        print(f"Twitter feed error: {e}")

async def start_twitter_feed(app, chat_id: int):
    """Launch background job for Twitter polling."""
    job_queue = app.job_queue
    job_queue.run_repeating(
        check_twitter_feed,
        interval=TWITTER_CHECK_INTERVAL,
        first=15,  # initial delay before first check
        chat_id=chat_id,
    )

# -----------------------------
# Wire up & run
# -----------------------------
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()
    app.job_queue  # ensures JobQueue is initialized

    app.add_handler(CommandHandler("start", start_cmd))
    app.add_handler(CommandHandler("roast", roast_cmd))
    app.add_handler(MessageHandler(filters.StatusUpdate.NEW_CHAT_MEMBERS, on_new_members))
    app.add_handler(CallbackQueryHandler(on_captcha_button, pattern=r"^captcha:"))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, text_guard))

    print("ü§ñ Grumpy George v1.2 is alive and grumbling...")

    # Start Twitter feed bridge (replace with your Telegram group ID)
    chat_id = -1003155680202  # <-- your real group ID

    async def on_startup(app):
        await start_twitter_feed(app, chat_id)

    app.post_init = on_startup

    app.run_polling(close_loop=False)


if __name__ == "__main__":
    main()
